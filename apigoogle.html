<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>Simple Polygon</title>
<!--   <style>
      @import url('https://fonts.googleapis.com/css?family=Roboto+Slab');
  </style> -->
  <style>
      /* Always set the map height explicitly to define the size of the div
      * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
  </style>
</head>
  <body>
    <div id="map"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    <script src="./lib/maplabel-compiled.js"></script>
    <script src="./lib/polylabel.js"></script>
    <script>

      // This example creates a simple polygon representing the Bermuda Triangle.
      var map;
      var infoWindow;
      // var overlay;
      // DebugOverlay.prototype = new google.maps.OverlayView();

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 10.8,
          center: {lat: -15.77556, lng: -47.79709},
          styles: [
              {elementType: 'geometry', stylers: [{color: '#242f3e'}]},
              {elementType: 'labels', stylers: [{visibility: 'off'}]},
              {featureType: 'poi.park', elementType: 'geometry', stylers: [{color: '#263c3f'}]},
              {featureType: 'road', elementType: 'geometry', stylers: [{color: '#38414e'}]},
              {featureType: 'road', elementType: 'geometry.stroke', stylers: [{color: '#212a37'}]},
              {featureType: 'road.highway', elementType: 'geometry', stylers: [{color: '#746855'}]},
              {featureType: 'road.highway', elementType: 'geometry.stroke', stylers: [{color: '#1f2835'}]},
              {featureType: 'transit', elementType: 'geometry', stylers: [{color: '#2f3948'}]},
              {featureType: 'water', elementType: 'geometry', stylers: [{color: '#17263c'}]}
          ]
        });
        // var neBound = new google.maps.LatLng(-15.66, -47.79);
        // var swBound = new google.maps.LatLng(-15.79214181, -47.88661518216243);
        // var bounds = new google.maps.LatLngBounds(swBound, neBound);

         /* console.log(map) */;
        // var srcImage = 'https://i.imgur.com/77kuHBR.jpg';
        // overlay = new DebugOverlay(bounds, srcImage, map);

        var localities = ['distrito_federal','brasilia','gama','taguatinga','brazlandia','sobradinho','planaltina','paranoa','nucleo_bandeirante','ceilandia','guara','cruzeiro','samambaia','santa_maria','sao_sebastiao','recanto_das_emas','lago_sul','riacho_fundo','lago_norte','candangolandia','aguas_claras','riacho_fundo_ii','sudoeste_octogonal','varjao','park_way','scia','sobradinho_ii','jardim_botanico','itapoa','sia','vicente_pires','fercal']

        localities.forEach(function(key, value){
          map.data.loadGeoJson('http://localhost:3000/jsons?file='+key)
        });

        map.data.setStyle(function(feature) {
          var city = feature.getProperty('name');
          var strokeColor = 'green';
          var strokeWeight = 2;
          var fillOpacity = 0.35;
          var strokeOpacity = 1;
          if (city == 'Distrito Federal') {
            strokeColor = '#000000';
            fillOpacity = 0.0;
            strokeOpacity = 1.0;
            strokeWeight = 4;
          }
          return /** @type {google.maps.Data.StyleOptions} */ {
            fillColor: 'green',
            strokeColor : strokeColor,
            fillOpacity : fillOpacity,
            strokeOpacity : strokeOpacity,
            strokeWeight : strokeWeight
          };
        });
        google.maps.event.addListener(map.data,'addfeature',function(e){
          if(e.feature.getGeometry().getType() === 'Polygon'){
            var bounds=new google.maps.LatLngBounds();
            var polygon = [];
            e.feature.getGeometry().getArray().forEach(function(path){
              path.getArray().forEach(function(latLng){
                bounds.extend(latLng);
                polygon.push([latLng.lat(), latLng.lng()]);
              });
            });
            // console.log(JSON.stringify([polygon]));
            p = polylabel([polygon], 300);
            var center = {'lat': p[0],'lng': p[1]};
            e.feature.setProperty('bounds', bounds);
            e.feature.setProperty('med_center', center);
            var mapLabel = new MapLabel({
              text: e.feature.getProperty('name'),
              position: new google.maps.LatLng(center.lat,center.lng),
              map: map,
              fontSize: 14,
              align: 'left',
              fontColor: '#d59563',
              fontFamily: 'Roboto Slab',
              strokeColor:'#242f3e',
              paneType: 'floatPane',
              strokeWeight: 3
            });
            console.log(latLng2Point(bounds.getCenter(), map));
          }
        });

        function latLng2Point(latLng, map) {
          var topRight = map.getProjection().fromLatLngToPoint(map.getBounds().getNorthEast());
          var bottomLeft = map.getProjection().fromLatLngToPoint(map.getBounds().getSouthWest());
          var scale = Math.pow(2, map.getZoom());
          var worldPoint = map.getProjection().fromLatLngToPoint(latLng);
          return new google.maps.Point((worldPoint.x - bottomLeft.x) * scale, (worldPoint.y - topRight.y) * scale);
        }

        google.maps.event.addListener(map.data,'click',function(e){
          var bounds=e.feature.getProperty('bounds');
          var center=e.feature.getProperty('med_center');
          if(bounds && center){
            alert('bounds:\n'+bounds.toString());
            alert('center:\n'+JSON.stringify(center));
          }
        });

        // var bounds = {
        //   9: [[41939, 41940], [101315, 101317]],
        //   10: [[555, 558], [373, 377]],
        //   11: [[1113, 1116], [749, 754]],
        //   12: [[2225, 2233], [1503, 1510]]
        // };

        // var imageMapType = new google.maps.ImageMapType({
        //   getTileUrl: function(coord, zoom) {
        //     console.log(JSON.stringify(coord), zoom);
        //     if (zoom < 8.8 || zoom > 12.8 ||
        //         bounds[zoom][0][0] > coord.x || coord.x > bounds[zoom][0][1] ||
        //         bounds[zoom][1][0] > coord.y || coord.y > bounds[zoom][1][1]) {
        //       return null;
        //     }
        //     return ['//www.gstatic.com/io2010maps/tiles/5/L2_',
        //         zoom, '_', coord.x, '_', coord.y, '.png'].join('');
        //   },
        //   tileSize: new google.maps.Size(256, 256)
        // });

        // map.overlayMapTypes.push(imageMapType);
      };

      // function DebugOverlay(bounds, image, map) {
      //   this.bounds_ = bounds;
      //   this.image_ = image;
      //   this.map_ = map;
      //   this.div_ = null;
      //   this.setMap(map);
      // }
      //
      // DebugOverlay.prototype.onAdd = function() {
      //
      //   var div = document.createElement('div');
      //   div.style.borderStyle = 'none';
      //   div.style.borderWidth = '0px';
      //   div.style.position = 'absolute';
      //   var img = document.createElement('img');
      //   img.src = this.image_;
      //   img.style.width = '100%';
      //   img.style.height = '100%';
      //   img.style.opacity = '0.9';
      //   img.style.position = 'absolute';
      //   div.appendChild(img);
      //   this.div_ = div;
      //   var panes = this.getPanes();
      //   panes.floatPane.appendChild(div);
      // };
      //
      // DebugOverlay.prototype.draw = function() {
      //   var overlayProjection = this.getProjection();
      //   var sw = overlayProjection.fromLatLngToDivPixel(this.bounds_.getSouthWest());
      //   var ne = overlayProjection.fromLatLngToDivPixel(this.bounds_.getNorthEast());
      //   var div = this.div_;
      //   div.style.left = sw.x + 'px';
      //   div.style.top = ne.y + 'px';
      //   div.style.width = (ne.x - sw.x) + 'px';
      //   div.style.height = (sw.y - ne.y) + 'px';
      // };

      google.maps.event.addDomListener(window, 'load', initMap);

    </script>
  </body>
  </html>
